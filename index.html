
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AL-NOOR DAIRY | Milk Supply Management</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
      background: #f7f7f7;
    }
    h1 {
      text-align: center;
      color: #2b6cb0;
    }
    .client {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .client-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .client-actions button {
      background: none;
      border: none;
      cursor: pointer;
      margin-left: 8px;
      font-size: 16px;
      color: #2b6cb0;
    }
    .client-actions button:hover {
      color: #1a4b8a;
    }
    input, button {
      padding: 8px;
      margin: 5px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #edf2f7;
    }
    .total {
      font-weight: bold;
      color: green;
    }
    .fold-content {
      display: none;
      margin-top: 10px;
    }
    .toggle-btn {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #2b6cb0;
    }
    .summary {
      margin-top: 10px;
      background: #f0fff4;
      padding: 10px;
      border-radius: 6px;
    }
    .pdf-buttons {
      margin-bottom: 10px;
      display: flex;
      gap: 10px;
    }
    .pdf-buttons button {
      background: #2b6cb0;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 6px 10px;
      cursor: pointer;
    }
    .pdf-buttons button:hover {
      background: #1a4b8a;
    }
    .total-report-btn {
      display: block;
      margin: 20px auto;
      background: #38a169;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
    .total-report-btn:hover {
      background: #2f855a;
    }
    #report-modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    .report-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    .close-btn {
      background: #e53e3e;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 8px 12px;
      cursor: pointer;
      margin-top: 15px;
    }
    .close-btn:hover {
      background: #c53030;
    }
  </style>
</head>
<body>
  <h1>ü•õ AL-NOOR DAIRY üêÑ<br>Milk Supply Management System</h1>

  <div class="add-client-form">
    <h3>Add New Client</h3>
    <input type="text" id="client-name" placeholder="Client Name" required />
    <input type="number" id="client-price" placeholder="Default Price (Rs.)" required />
    <button onclick="addClient()">Add Client</button>
  </div>

  <button class="total-report-btn" onclick="showTotalReport()">üìä Show Overall Total Report</button>

  <div id="clients-container"></div>

  <div id="report-modal">
    <div class="report-content">
      <h3>AL-NOOR DAIRY ‚Äì Overall Report</h3>
      <div id="report-body"></div>
      <button class="close-btn" onclick="closeReport()">Close</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    let clients = JSON.parse(localStorage.getItem("clients")) || [];

    function saveClients() {
      localStorage.setItem("clients", JSON.stringify(clients));
    }

    function renderClients() {
      const container = document.getElementById("clients-container");
      container.innerHTML = "";

      clients.forEach(client => {
        const div = document.createElement("div");
        div.className = "client";

        div.innerHTML = `
          <div class="client-header">
            <h2 onclick="toggleFold('${client.name}')">${client.name}</h2>
            <div class="client-actions">
              <button onclick="editClient('${client.name}')">‚úèÔ∏è</button>
              <button onclick="deleteClient('${client.name}')">üóëÔ∏è</button>
              <button class="toggle-btn" id="toggle-${client.name}">+</button>
            </div>
          </div>

          <div class="fold-content" id="fold-${client.name}">
            <div class="pdf-buttons">
              <button onclick="downloadPDF('${client.name}')">üìÑ Download PDF</button>
              <button onclick="sharePDF('${client.name}')">üì§ Share PDF</button>
            </div>

            <p>Default Price per Liter: <strong>Rs. ${client.defaultPrice}</strong></p>

            <form onsubmit="addEntry(event, '${client.name}')">
              <input type="date" id="date-${client.name}" required />
              <input type="number" id="qty-${client.name}" placeholder="Liters" min="0" step="0.1" required />
              <input type="number" id="price-${client.name}" placeholder="Price (Rs.)" step="0.1" value="${client.defaultPrice}" />
              <button type="submit">Add Entry</button>
            </form>

            <div id="pdf-content-${client.name}">
              <table id="table-${client.name}">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Quantity (L)</th>
                    <th>Price (Rs./L)</th>
                    <th>Total (Rs.)</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <td colspan="4" class="total">Monthly Total:</td>
                    <td id="total-${client.name}" class="total">0</td>
                  </tr>
                </tfoot>
              </table>

              <div class="summary" id="summary-${client.name}"></div>
            </div>
          </div>
        `;

        container.appendChild(div);

        const today = new Date().toISOString().split('T')[0];
        document.getElementById(`date-${client.name}`).value = today;

        renderTable(client.name);
        updateSummary(client.name);
      });
    }

    function toggleFold(clientName) {
      const content = document.getElementById(`fold-${clientName}`);
      const btn = document.getElementById(`toggle-${clientName}`);
      if (content.style.display === "none" || !content.style.display) {
        content.style.display = "block";
        btn.textContent = "‚àí";
      } else {
        content.style.display = "none";
        btn.textContent = "+";
      }
    }

    function addClient() {
      const name = document.getElementById("client-name").value.trim();
      const price = parseFloat(document.getElementById("client-price").value);
      if (name && price) {
        if (clients.some(c => c.name === name)) {
          alert("Client already exists!");
          return;
        }
        clients.push({ name, defaultPrice: price, data: [] });
        saveClients();
        renderClients();
        document.getElementById("client-name").value = "";
        document.getElementById("client-price").value = "";
      } else {
        alert("Please fill both fields.");
      }
    }

    function editClient(name) {
      const client = clients.find(c => c.name === name);
      const newName = prompt("Enter new name:", client.name);
      const newPrice = parseFloat(prompt("Enter new default price:", client.defaultPrice));
      if (newName && !isNaN(newPrice)) {
        client.name = newName.trim();
        client.defaultPrice = newPrice;
        saveClients();
        renderClients();
      } else {
        alert("Invalid input!");
      }
    }

    function deleteClient(name) {
      if (confirm(`Are you sure you want to delete ${name}?`)) {
        clients = clients.filter(c => c.name !== name);
        saveClients();
        renderClients();
      }
    }

    function addEntry(e, clientName) {
      e.preventDefault();
      const client = clients.find(c => c.name === clientName);
      const date = document.getElementById(`date-${clientName}`).value;
      const qty = parseFloat(document.getElementById(`qty-${clientName}`).value);
      const price = parseFloat(document.getElementById(`price-${clientName}`).value);
      if (!date || isNaN(qty) || isNaN(price)) return;
      const total = qty * price;
      client.data.push({ date, qty, price, total });
      saveClients();
      renderTable(clientName);
      updateSummary(clientName);
      e.target.reset();
    }

    function renderTable(clientName) {
      const client = clients.find(c => c.name === clientName);
      const tbody = document.querySelector(`#table-${clientName} tbody`);
      tbody.innerHTML = "";
      client.data.forEach((entry, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${entry.date}</td>
          <td>${entry.qty.toFixed(1)}</td>
          <td>${entry.price.toFixed(2)}</td>
          <td>${entry.total.toFixed(2)}</td>
          <td>
            <button onclick="editEntry('${clientName}', ${index})">‚úèÔ∏è</button>
            <button onclick="deleteEntry('${clientName}', ${index})">üóëÔ∏è</button>
          </td>
        `;
        tbody.appendChild(row);
      });
      const total = client.data.reduce((sum, e) => sum + e.total, 0);
      document.getElementById(`total-${clientName}`).textContent = total.toFixed(2);
    }

    function editEntry(clientName, index) {
      const client = clients.find(c => c.name === clientName);
      const entry = client.data[index];

      const newDate = prompt("Edit date (YYYY-MM-DD):", entry.date);
      const newQty = parseFloat(prompt("Edit quantity (L):", entry.qty));
      const newPrice = parseFloat(prompt("Edit price (Rs./L):", entry.price));

      if (newDate && !isNaN(newQty) && !isNaN(newPrice)) {
        entry.date = newDate;
        entry.qty = newQty;
        entry.price = newPrice;
        entry.total = newQty * newPrice;
        saveClients();
        renderTable(clientName);
        updateSummary(clientName);
      } else {
        alert("Invalid input. Please try again.");
      }
    }

    function deleteEntry(clientName, index) {
      const client = clients.find(c => c.name === clientName);
      if (confirm("Delete this entry?")) {
        client.data.splice(index, 1);
        saveClients();
        renderTable(clientName);
        updateSummary(clientName);
      }
    }

    function updateSummary(clientName) {
      const client = clients.find(c => c.name === clientName);
      const totalLiters = client.data.reduce((sum, e) => sum + e.qty, 0);
      const suppliedDays = new Set(client.data.map(e => e.date)).size;
      const missedDays = Math.max(0, 30 - suppliedDays);
      document.getElementById(`summary-${clientName}`).innerHTML = `
        <p><strong>Total Liters:</strong> ${totalLiters.toFixed(1)} L</p>
        <p><strong>Days Milk Supplied:</strong> ${suppliedDays}</p>
        <p><strong>Days Missed:</strong> ${missedDays}</p>
      `;
    }

    function showTotalReport() {
      if (clients.length === 0) {
        alert("No clients added yet!");
        return;
      }
      let totalLiters = 0, totalAmount = 0, totalDays = 0;
      clients.forEach(c => {
        totalLiters += c.data.reduce((s, e) => s + e.qty, 0);
        totalAmount += c.data.reduce((s, e) => s + e.total, 0);
        totalDays += new Set(c.data.map(e => e.date)).size;
      });
      const reportBody = document.getElementById("report-body");
      reportBody.innerHTML = `
        <p><strong>Total Clients:</strong> ${clients.length}</p>
        <p><strong>Total Milk Supplied:</strong> ${totalLiters.toFixed(1)} L</p>
        <p><strong>Total Payment:</strong> Rs. ${totalAmount.toFixed(2)}</p>
        <p><strong>Total Days Milk Supplied:</strong> ${totalDays}</p>
      `;
      document.getElementById("report-modal").style.display = "flex";
    }

    function closeReport() {
      document.getElementById("report-modal").style.display = "none";
    }

    async function downloadPDF(clientName) {
      const element = document.getElementById(`pdf-content-${clientName}`);
      const { jsPDF } = window.jspdf;
      const canvas = await html2canvas(element, { scale: 2 });
      const imgData = canvas.toDataURL('image/png');
      const pdf = new jsPDF('p', 'mm', 'a4');
      pdf.text("AL-NOOR DAIRY", 10, 10);
      pdf.text(clientName + " - Milk Record", 10, 20);
      const imgWidth = 190;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;
      pdf.addImage(imgData, 'PNG', 10, 30, imgWidth, imgHeight);
      pdf.save(`${clientName}_Milk_Record.pdf`);
    }

    async function sharePDF(clientName) {
      const element = document.getElementById(`pdf-content-${clientName}`);
      const { jsPDF } = window.jspdf;
      const canvas = await html2canvas(element, { scale: 2 });
      const imgData = canvas.toDataURL('image/png');
      const pdf = new jsPDF();
      pdf.text("AL-NOOR DAIRY", 10, 10);
      pdf.text(clientName + " - Milk Record", 10, 20);
      pdf.addImage(imgData, 'PNG', 10, 30, 180, 0);
      const pdfBlob = pdf.output('blob');
      if (navigator.share) {
        const file = new File([pdfBlob], `${clientName}_Milk_Record.pdf`, { type: 'application/pdf' });
        navigator.share({
          title: `${clientName} Milk Record`,
          text: 'Here is the milk supply record PDF.',
          files: [file]
        });
      } else {
        alert("Sharing not supported on this device. Please download instead.");
      }
    }

    renderClients();
  </script>
</body>
</html>
